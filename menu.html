<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reservas de Menú</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #F8F8F8;
      padding: 20px;
      color: #333;
      position: relative;
    }

    /* Estilos para el botón de logout */
    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #666666;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .logout-btn:hover {
      background-color: #444444;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .logout-btn:active {
      transform: scale(0.95);
    }

    /* Tooltip para el botón de logout */
    .logout-btn::before {
      content: "Cerrar sesión";
      position: absolute;
      top: -40px;
      right: 0;
      background-color: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .logout-btn:hover::before {
      opacity: 1;
      visibility: visible;
    }

    /* Estilos para el botón de reservas */
    .reservas-btn {
      position: fixed;
      top: 20px;
      right: 80px;
      background-color: #3C8BD1;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .reservas-btn:hover {
      background-color: #095DA9;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .reservas-btn:active {
      transform: scale(0.95);
    }

    /* Tooltip para el botón de reservas */
    .reservas-btn::before {
      content: "Ver mis reservas";
      position: absolute;
      top: -40px;
      right: 0;
      background-color: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .reservas-btn:hover::before {
      opacity: 1;
      visibility: visible;
    }

    /* Estilos para el botón de órdenes */
    .ordenes-btn {
      position: fixed;
      top: 20px;
      right: 140px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .ordenes-btn:hover {
      background-color: #218838;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .ordenes-btn:active {
      transform: scale(0.95);
    }

    /* Tooltip para el botón de órdenes */
    .ordenes-btn::before {
      content: "Ver órdenes del día";
      position: absolute;
      top: -40px;
      right: 0;
      background-color: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .ordenes-btn:hover::before {
      opacity: 1;
      visibility: visible;
    }

    /* Modal de reservas */
    .modal-reservas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }

    .modal-reservas .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .modal-reservas .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .modal-reservas .close-btn:hover {
      color: #333;
    }

    .modal-reservas h2 {
      color: #095DA9;
      text-align: center;
      margin-bottom: 20px;
      padding-right: 30px;
    }

    .modal-reservas .datos-usuario {
      text-align: center;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .modal-reservas .etiqueta {
      font-weight: bold;
      color: #095DA9;
    }

    .modal-reservas .titulo-reservas {
      text-align: center;
      font-weight: bold;
      color: #095DA9;
      margin: 20px 0 15px 0;
      border-top: 2px solid #eee;
      padding-top: 15px;
    }

    .modal-reservas .reserva-dia {
      background: #f8f9fa;
      padding: 10px 15px;
      margin-bottom: 8px;
      border-radius: 8px;
      border-left: 4px solid #3C8BD1;
    }

    .modal-reservas .no-reservas {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }

    /* Estilos para mostrar el nombre del usuario */
    .usuario-info {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: #095DA9;
      color: white;
      padding: 10px 15px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .usuario-info .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #095DA9;
    }

    .usuario-info .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    h1 {
      color: #095DA9;
      text-align: center;
    }

    .formulario {
      max-width: 800px;
      margin: 0 auto;
    }

    .campo {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
    }

    input[type="text"],
    input[type="tel"],
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .dia {
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .dia h3 {
      margin: 0 0 10px;
      color: #095DA9;
      text-align: center; /* Centrar etiqueta día */
    }

    .linea-dia {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    .linea-dia .mini-boton {
      flex: 1;
      max-width: 160px;
    }

    .linea-dia .opciones-dia {
      display: flex;
      flex: 3;
      gap: 10px;
      justify-content: flex-end;
    }

    .opciones-dia label {
      flex: 1;
      text-align: center;
      user-select: none;
    }

    .disponibilidad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 30px 0;
      text-align: center;
    }

    @media (max-width: 700px) {
      .disponibilidad {
        grid-template-columns: 1fr;
      }
    }

    .disponibilidad div {
      background: #BBE3FC;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .disponibilidad .etiqueta {
      font-size: 1.1em;
      font-weight: bold;
      color: #095DA9;
      margin-bottom: 5px;
    }

    .disponibilidad span {
      font-size: 2.5em;
      font-weight: bold;
      display: block;
    }

    .disponibilidad .sub {
      font-size: 0.9em;
      color: #666;
    }

    /* Botones "seleccionar todo" y por día */
    button.no-seleccionado {
      background-color: #3C8BD1; /* Azul desde inicio */
      color: white;
      border: none;
      transition: background-color 0.3s ease;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      user-select: none;
    }

    button.no-seleccionado:hover {
      background-color: #999999; /* Gris al hover */
      color: white;
    }

    button.seleccionado {
      background-color: #999999; /* Gris cuando seleccionado */
      color: white;
      border: none;
      transition: background-color 0.3s ease;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      user-select: none;
    }

    button.seleccionado:hover {
      background-color: #3C8BD1; /* Azul al hover si está seleccionado */
      color: white;
    }

    /* Botón guardar reserva */
    #guardar {
      background-color: #FF6600; /* naranja */
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 30px;
      width: 100%;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    #guardar:hover {
      background-color: #e65c00; /* naranja oscuro hover */
    }

    .contador-animado {
      transition: all 0.3s ease-out;
      transform: scale(1.3);
      color: #000;
    }

    .info {
      font-size: 0.9em;
      color: #555;
      margin-top: 10px;
      text-align: center;
    }

    #confirmacion {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #confirmacion .modal {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    /* Modal de reserva existente */
    .modal-reserva-existente {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1003;
    }

    .modal-reserva-existente .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      position: relative;
      text-align: center;
    }

    .modal-reserva-existente h2 {
      color: #D9534F;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .mensaje-reserva-existente {
      margin-bottom: 25px;
      line-height: 1.6;
    }

    .mensaje-reserva-existente p {
      margin-bottom: 10px;
      color: #333;
    }

    .botones-modal {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .botones-modal button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
      min-width: 120px;
    }

    .boton-verde {
      background-color: #28A745;
      color: white;
    }

    .boton-verde:hover {
      background-color: #218838;
    }

    .boton-gris {
      background-color: #6C757D;
      color: white;
    }

    .boton-gris:hover {
      background-color: #5A6268;
    }

    /* Estilos para el botón de cancelar reserva */
    .boton-cancelar {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 20px;
      transition: all 0.3s ease;
      width: 100%;
    }

    .boton-cancelar:hover {
      background-color: #c82333;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .boton-cancelar:active {
      transform: translateY(0);
    }

    /* Estilos para los botones de la modal */
    .botones-modal-reservas {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }

    .boton-cancelar {
      flex: 1;
      max-width: 200px;
    }
  </style>
</head>
<body>
  <!-- Información del usuario -->
  <div class="usuario-info" id="usuarioInfo">
    <div class="avatar" id="usuarioAvatar">
      👤
    </div>
    <span id="usuarioNombre">Cargando...</span>
  </div>

  <!-- Botón de logout -->
  <button class="logout-btn" id="logoutBtn" title="Cerrar sesión">
    🚪
  </button>

  <!-- Botón de reservas -->
  <button class="reservas-btn" id="reservasBtn" title="Ver mis reservas">
    📅
  </button>

  <h1>Reservas de Comidas para Congreso</h1>

  <div class="formulario">

    <div class="disponibilidad">
      <div>
        <div class="etiqueta">🥐 Desayunos</div>
        <span id="contador-desayuno">--</span>
        <div class="sub">(disponibles)</div>
      </div>
      <div>
        <div class="etiqueta">🍽️ Comidas</div>
        <span id="contador-comida">--</span>
        <div class="sub">(disponibles)</div>
      </div>
      <div>
        <div class="etiqueta">🌙 Cenas</div>
        <span id="contador-cena">--</span>
        <div class="sub">(disponibles)</div>
      </div>
    </div>

    <div class="campo">
      <label for="nombre">Nombre completo</label>
      <input type="text" id="nombre" required />
    </div>

    <div class="campo">
      <label for="celular">Número de celular</label>
      <input type="tel" id="celular" required />
    </div>

    <div class="campo">
      <label for="personas">Quiero la misma reserva para:</label>
      <select id="personas">
        <option value="1">1 Persona</option>
        <option value="2">2 Personas</option>
        <option value="3">3 Personas</option>
        <option value="4">4 Personas</option>
        <option value="5">5 Personas</option>
      </select>
    </div>

    <div class="campo info">
      La reserva quedará completa una vez se confirme vía WhatsApp por el proveedor del servicio.
    </div>

    <div class="campo">
      <button type="button" id="seleccionar-todo" class="no-seleccionado">
        Seleccionar todas las comidas de todos los días
      </button>
    </div>

    <div id="fechas"></div>

    <button id="guardar">Guardar reserva</button>
  </div>

  <div id="confirmacion">
    <div class="modal">
      <p>Mantente al pendiente de WhatsApp o tus SMS para la confirmación del proveedor.</p>
      <button id="aceptar">Aceptar</button>
    </div>
  </div>

  <!-- Modal de reservas -->
  <div class="modal-reservas" id="modalReservas">
    <div class="modal-content">
      <button class="close-btn" id="closeModal">&times;</button>
      <h2>Mis Reservas</h2>
      <div id="contenidoReservas">
        <!-- El contenido se generará dinámicamente -->
      </div>
      <div class="botones-modal-reservas">
        <button id="cancelarReserva" class="boton-cancelar">Cancelar Reserva</button>
      </div>
    </div>
  </div>

  <!-- Modal de reserva existente -->
  <div class="modal-reserva-existente" id="modalReservaExistente">
    <div class="modal-content">
      <button class="close-btn" id="closeModalExistente">&times;</button>
      <h2>⚠️ Ya tienes una reserva activa</h2>
      <div class="mensaje-reserva-existente">
        <p>Ya tienes una reserva registrada en el sistema.</p>
        <p>Para consultar los detalles de tu reserva actual, haz clic en el ícono del calendario 📅 en la parte superior derecha.</p>
        <p>Si deseas hacer una nueva reserva, primero debes cancelar la existente.</p>
      </div>
      <div class="botones-modal">
        <button id="verReservaExistente" class="boton-verde">Ver mi reserva actual</button>
        <button id="cerrarModalExistente" class="boton-gris">Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabase = createClient(
      'https://zfdvimulaesogcydqyly.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmZHZpbXVsYWVzb2djeWRxeWx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjgxNzAsImV4cCI6MjA2NjQ0NDE3MH0.UXJ3BM0t06n6Z-RFx4lgZZLhabWEdTAvuLAeETJ26fw'
    )

    // Función para verificar directamente la base de datos
    async function verificarBaseDeDatos() {
      console.log('=== VERIFICANDO BASE DE DATOS DIRECTAMENTE ===')
      
      try {
        // Hacer una consulta directa sin caché
        const { data, error } = await supabase
          .from('disponibilidad')
          .select('*')
          .limit(1)
          .maybeSingle()

        if (error) {
          console.error('Error consultando base de datos:', error)
          return null
        }

        if (!data) {
          console.error('No se encontraron datos en la base de datos')
          return null
        }

        console.log('Datos directos de la base de datos:', data)
        
        // Actualizar contadores inmediatamente
        animarContador(contadores.desayuno, data.desayunos)
        animarContador(contadores.comida, data.comidas)
        animarContador(contadores.cena, data.cenas)
        
        return data
      } catch (error) {
        console.error('Error en verificarBaseDeDatos:', error)
        return null
      }
    }

    // Función para forzar actualización agresiva de contadores
    async function forzarActualizacionContadores() {
      console.log('=== FORZANDO ACTUALIZACIÓN AGRESIVA DE CONTADORES ===')
      
      try {
        // Primera verificación directa de la base de datos
        console.log('1. Verificación directa de base de datos...')
        await verificarBaseDeDatos()
        
        // Segunda verificación después de 1 segundo
        setTimeout(async () => {
          console.log('2. Segunda verificación directa...')
          await verificarBaseDeDatos()
        }, 1000)
        
        // Tercera verificación después de 3 segundos
        setTimeout(async () => {
          console.log('3. Tercera verificación directa...')
          await verificarBaseDeDatos()
        }, 3000)
        
        // Cuarta verificación después de 5 segundos
        setTimeout(async () => {
          console.log('4. Cuarta verificación directa...')
          await verificarBaseDeDatos()
        }, 5000)
        
      } catch (error) {
        console.error('Error en forzarActualizacionContadores:', error)
      }
    }

    // Función para verificar si venimos de una cancelación
    function verificarCancelacion() {
      const urlParams = new URLSearchParams(window.location.search)
      const cancelado = urlParams.get('cancelado')
      
      if (cancelado === 'true') {
        console.log('=== DETECTADA CANCELACIÓN ===')
        console.log('Ejecutando actualización agresiva de contadores...')
        
        // Limpiar el parámetro de la URL
        window.history.replaceState({}, document.title, window.location.pathname)
        
        // Ejecutar actualización agresiva
        forzarActualizacionContadores()
      }
    }

    // Función para sincronizar información del usuario con la sesión actual
    async function sincronizarUsuarioConSesion() {
      try {
        const { data: { session } } = await supabase.auth.getSession()
        if (session && session.user) {
          const usuarioActual = JSON.parse(localStorage.getItem('usuario_actual'))
          
          // Verificar si la información del usuario ha cambiado
          if (!usuarioActual || 
              usuarioActual.id !== session.user.id ||
              usuarioActual.email !== session.user.email ||
              usuarioActual.nombre !== (session.user.user_metadata?.full_name || session.user.email)) {
            
            console.log('Actualizando información del usuario')
            
            // Actualizar información del usuario
            localStorage.setItem('usuario_actual', JSON.stringify({
              id: session.user.id,
              email: session.user.email,
              nombre: session.user.user_metadata?.full_name || session.user.email,
              avatar_url: session.user.user_metadata?.avatar_url
            }))
            
            // Recargar la información en la UI
            cargarInformacionUsuario()
          }
        }
      } catch (error) {
        console.error('Error sincronizando usuario:', error)
      }
    }

    // Función para cargar información del usuario
    function cargarInformacionUsuario() {
      const usuarioActual = JSON.parse(localStorage.getItem('usuario_actual'))
      
      if (usuarioActual) {
        const nombreElement = document.getElementById('usuarioNombre')
        const avatarElement = document.getElementById('usuarioAvatar')
        
        nombreElement.textContent = usuarioActual.nombre
        
        if (usuarioActual.avatar_url) {
          avatarElement.innerHTML = `<img src="${usuarioActual.avatar_url}" alt="Avatar" />`
        } else {
          // Mostrar inicial del nombre si no hay avatar
          const inicial = usuarioActual.nombre.charAt(0).toUpperCase()
          avatarElement.textContent = inicial
        }
      } else {
        // Si no hay usuario, redirigir al login
        window.location.href = './index.html'
      }
    }

    // Función para obtener reservas del usuario desde la base de datos
    async function cargarReservasUsuario() {
      try {
        const usuarioActual = JSON.parse(localStorage.getItem('usuario_actual'))
        if (!usuarioActual) return

        const { data, error } = await supabase
          .from('reservas')
          .select('*')
          .eq('user_id', usuarioActual.id)
          .order('fecha', { ascending: true })

        if (error) {
          console.error('Error obteniendo reservas:', error)
          return
        }

        if (data && data.length > 0) {
          localStorage.setItem('reserva_actual', JSON.stringify(data))
        }
      } catch (error) {
        console.error('Error en cargarReservasUsuario:', error)
      }
    }

    // Función para obtener disponibilidad actual
    async function obtenerDisponibilidadActual() {
      try {
        const { data, error } = await supabase
          .from('disponibilidad')
          .select('*')
          .limit(1)
          .maybeSingle()

        if (error) {
          console.error('Error al obtener disponibilidad:', error)
          return null
        }

        return data
      } catch (error) {
        console.error('Error en obtenerDisponibilidadActual:', error)
        return null
      }
    }

    // Función para actualizar disponibilidad
    async function actualizarDisponibilidad(nDesayunos, nComidas, nCenas) {
      try {
        const { error } = await supabase
          .from('disponibilidad')
          .update({
            desayunos: nDesayunos,
            comidas: nComidas,
            cenas: nCenas
          })
          .eq('id', 1)

        if (error) {
          console.error('Error actualizando disponibilidad:', error)
          return false
        }
        return true
      } catch (error) {
        console.error('Error en actualizarDisponibilidad:', error)
        return false
      }
    }

    // Función para eliminar reservas de la base de datos
    async function eliminarReservas(reservas) {
      try {
        const usuarioActual = JSON.parse(localStorage.getItem('usuario_actual'))
        if (!usuarioActual) {
          console.error('No se encontró información del usuario')
          return false
        }

        // Eliminar reservas por user_id
        const { error } = await supabase
          .from('reservas')
          .delete()
          .eq('user_id', usuarioActual.id)

        if (error) {
          console.error('Error eliminando reservas:', error)
          return false
        }
        return true
      } catch (error) {
        console.error('Error en eliminarReservas:', error)
        return false
      }
    }

    const fechaInicio = new Date(2025, 6, 2)  // Julio es mes 6 (0 index)
    const fechaFin = new Date(2025, 6, 12)

    const contadores = {
      desayuno: document.getElementById('contador-desayuno'),
      comida: document.getElementById('contador-comida'),
      cena: document.getElementById('contador-cena'),
    }

    function formatearFecha(fecha) {
      const dias = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado']
      const meses = [
        'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
      ]

      const diaSemana = dias[fecha.getDay()]
      const dia = String(fecha.getDate()).padStart(2, '0')
      const mes = meses[fecha.getMonth()]
      const anio = fecha.getFullYear()

      return `${diaSemana}, ${dia} de ${mes} de ${anio}`
    }

    function animarContador(elemento, nuevoValor) {
      if (!elemento) {
        console.error('Elemento contador no encontrado')
        return
      }
      
      const valorActual = parseInt(elemento.textContent) || 0
      console.log(`Contador: ${valorActual} -> ${nuevoValor}`)
      
      if (valorActual !== nuevoValor) {
        elemento.textContent = nuevoValor
        elemento.classList.add('contador-animado')
        setTimeout(() => {
          elemento.classList.remove('contador-animado')
        }, 300)
      }
    }

    // Función para refrescar contadores manualmente
    async function refrescarContadores() {
      console.log('Refrescando contadores...')
      const resultado = await cargarContadores(true)
      if (resultado) {
        console.log('Contadores actualizados:', resultado)
      } else {
        console.error('Error al refrescar contadores')
      }
    }

    async function cargarContadores(forzarActualizacion = false) {
      try {
        // Si se fuerza la actualización, agregar un timestamp para evitar caché
        const { data, error } = await supabase
          .from('disponibilidad')
          .select('*')
          .limit(1)
          .maybeSingle()

        if (error) {
          console.error('Error al obtener disponibilidad:', error)
          return null
        }

        if (!data) {
          console.error('No se encontraron datos de disponibilidad')
          return null
        }

        console.log('Disponibilidad actual:', data)

        // Actualizar contadores en la UI
        animarContador(contadores.desayuno, data.desayunos)
        animarContador(contadores.comida, data.comidas)
        animarContador(contadores.cena, data.cenas)

        return data // devolver disponibilidad actual
      } catch (error) {
        console.error('Error en cargarContadores:', error)
        return null
      }
    }

    async function guardarReserva() {
      const nombre = document.getElementById('nombre').value.trim()
      const celular = document.getElementById('celular').value.trim()
      const personas = parseInt(document.getElementById('personas').value)

      if (!nombre || !celular || !personas) {
        alert('Por favor llena todos los campos obligatorios.')
        return
      }

      const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked')
      if (checkboxes.length === 0) {
        alert('Selecciona al menos una comida.')
        return
      }

      // Verificar si el usuario ya tiene reservas existentes
      const tieneReservasExistentes = await verificarReservasExistentes()
      if (tieneReservasExistentes) {
        mostrarModalReservaExistente()
        return
      }

      // Obtener información del usuario actual
      const usuarioActual = JSON.parse(localStorage.getItem('usuario_actual'))
      if (!usuarioActual) {
        alert('Error: No se encontró información del usuario. Por favor, inicia sesión nuevamente.')
        window.location.href = './index.html'
        return
      }

      const reservas = []
      let totalDesayunos = 0, totalComidas = 0, totalCenas = 0

      checkboxes.forEach(cb => {
        const [tipo, fecha] = cb.value.split('|')
        reservas.push({ 
          nombre, 
          celular, 
          tipo, 
          fecha, 
          personas,
          user_id: usuarioActual.id  // Agregar user_id a cada reserva
        })
        if (tipo === 'desayuno') totalDesayunos += personas
        else if (tipo === 'comida') totalComidas += personas
        else if (tipo === 'cena') totalCenas += personas
      })

      // Obtener la disponibilidad actual
      const dispActual = await cargarContadores()

      if (!dispActual) {
        alert('No se pudo obtener disponibilidad actual.')
        return
      }

      // Validar si hay suficiente disponibilidad para descontar
      if (totalDesayunos > dispActual.desayunos ||
          totalComidas > dispActual.comidas ||
          totalCenas > dispActual.cenas) {
        alert('No hay suficiente disponibilidad para la cantidad seleccionada.')
        return
      }

      // Guardar reserva
      const { error } = await supabase.from('reservas').insert(reservas)
      if (error) {
        alert('Error al guardar reserva. Intenta de nuevo.')
        console.error(error)
        return
      }

      // Actualizar disponibilidad restando lo reservado
      await actualizarDisponibilidad(
        dispActual.desayunos - totalDesayunos,
        dispActual.comidas - totalComidas,
        dispActual.cenas - totalCenas
      )

      // Actualizar contadores en UI
      animarContador(contadores.desayuno, dispActual.desayunos - totalDesayunos)
      animarContador(contadores.comida, dispActual.comidas - totalComidas)
      animarContador(contadores.cena, dispActual.cenas - totalCenas)

      localStorage.setItem('reserva_actual', JSON.stringify(reservas))
      document.getElementById('confirmacion').style.display = 'flex'
    }

    function generarFormularioFechas() {
      const contenedor = document.getElementById('fechas')
      if (!contenedor) return

      for (let d = new Date(fechaInicio); d <= fechaFin; d.setDate(d.getDate() + 1)) {
        const fecha = new Date(d) // Copia
        const fechaISO = fecha.toISOString().slice(0, 10)

        const bloque = document.createElement('div')
        bloque.className = 'dia'

        const titulo = document.createElement('h3')
        titulo.textContent = formatearFecha(fecha)
        bloque.appendChild(titulo)

        const linea = document.createElement('div')
        linea.className = 'linea-dia'

        const btnDia = document.createElement('button')
        btnDia.className = 'mini-boton no-seleccionado'
        btnDia.type = 'button'
        btnDia.textContent = 'Seleccionar todas'

        let diaSeleccionado = false
        const checkboxes = []

        btnDia.addEventListener('click', () => {
          diaSeleccionado = !diaSeleccionado
          checkboxes.forEach(cb => cb.checked = diaSeleccionado)
          btnDia.textContent = diaSeleccionado ? 'Deseleccionar todas' : 'Seleccionar todas'
          btnDia.classList.toggle('seleccionado', diaSeleccionado)
          btnDia.classList.toggle('no-seleccionado', !diaSeleccionado)
        })

        const opciones = document.createElement('div')
        opciones.className = 'opciones-dia'

        const tipos = ['desayuno', 'comida', 'cena']
        tipos.forEach(tipo => {
          const label = document.createElement('label')
          const input = document.createElement('input')
          input.type = 'checkbox'
          input.value = `${tipo}|${fechaISO}`
          label.appendChild(input)
          label.append(` ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`)
          opciones.appendChild(label)
          checkboxes.push(input)
        })

        linea.appendChild(btnDia)
        linea.appendChild(opciones)
        bloque.appendChild(linea)
        contenedor.appendChild(bloque)
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Verificar que el usuario esté autenticado
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        window.location.href = './index.html'
        return
      }

      // Verificar que tengamos información del usuario en localStorage
      const usuarioActual = JSON.parse(localStorage.getItem('usuario_actual'))
      if (!usuarioActual) {
        // Si no hay información del usuario, intentar obtenerla de la sesión
        localStorage.setItem('usuario_actual', JSON.stringify({
          id: session.user.id,
          email: session.user.email,
          nombre: session.user.user_metadata?.full_name || session.user.email,
          avatar_url: session.user.user_metadata?.avatar_url
        }))
      }

      // Configurar listener para cambios de autenticación
      supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_OUT') {
          console.log('Usuario cerró sesión')
          // Redirigir al login cuando el usuario cierra sesión
          window.location.href = './index.html'
        }
        
        if (event === 'USER_UPDATED' && session) {
          console.log('Información del usuario actualizada')
          // Actualizar información del usuario si cambia
          localStorage.setItem('usuario_actual', JSON.stringify({
            id: session.user.id,
            email: session.user.email,
            nombre: session.user.user_metadata?.full_name || session.user.email,
            avatar_url: session.user.user_metadata?.avatar_url
          }))
          cargarInformacionUsuario()
        }
      })

      generarFormularioFechas()

      let todosSeleccionados = false
      const botonTodo = document.getElementById('seleccionar-todo')
      botonTodo.classList.add('no-seleccionado')

      botonTodo.addEventListener('click', () => {
        todosSeleccionados = !todosSeleccionados
        document.querySelectorAll('#fechas input[type="checkbox"]').forEach(cb => cb.checked = todosSeleccionados)
        botonTodo.textContent = todosSeleccionados
          ? 'Deseleccionar todas las comidas de todos los días'
          : 'Seleccionar todas las comidas de todos los días'

        botonTodo.classList.toggle('seleccionado', todosSeleccionados)
        botonTodo.classList.toggle('no-seleccionado', !todosSeleccionados)

        // También actualizar los botones por día para que reflejen el mismo estado
        document.querySelectorAll('.dia').forEach(diaDiv => {
          const btnDia = diaDiv.querySelector('button.mini-boton')
          btnDia.textContent = todosSeleccionados ? 'Deseleccionar todas' : 'Seleccionar todas'
          btnDia.classList.toggle('seleccionado', todosSeleccionados)
          btnDia.classList.toggle('no-seleccionado', !todosSeleccionados)
        })
      })

      // Inicializar botones por día en azul (no-seleccionado)
      document.querySelectorAll('.dia').forEach(diaDiv => {
        const btnDia = diaDiv.querySelector('button.mini-boton')
        btnDia.classList.add('no-seleccionado')
      })

      document.getElementById('guardar').addEventListener('click', guardarReserva)
      document.getElementById('aceptar').addEventListener('click', () => {
        window.location.href = 'reserva.html'
      })

      // Funcionalidad del botón de logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
          try {
            // Cerrar sesión de Supabase
            const { error } = await supabase.auth.signOut()
            if (error) {
              console.error('Error al cerrar sesión:', error)
            }
            
            // Limpiar TODOS los datos locales
            localStorage.clear()
            sessionStorage.clear()
            
            // Redirigir a la página principal usando URL relativa
            window.location.href = './index.html'
          } catch (error) {
            console.error('Error durante el logout:', error)
            // Aún así limpiar datos y redirigir
            localStorage.clear()
            sessionStorage.clear()
            window.location.href = './index.html'
          }
        }
      })

      // Funcionalidad del botón de reservas
      document.getElementById('reservasBtn').addEventListener('click', () => {
        mostrarReservas()
      })

      // Cerrar modal de reservas
      document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('modalReservas').style.display = 'none'
      })

      // Cerrar modal al hacer clic fuera de él
      document.getElementById('modalReservas').addEventListener('click', (e) => {
        if (e.target.id === 'modalReservas') {
          document.getElementById('modalReservas').style.display = 'none'
        }
      })

      // Funcionalidad de la modal de reserva existente
      document.getElementById('closeModalExistente').addEventListener('click', () => {
        document.getElementById('modalReservaExistente').style.display = 'none'
      })

      document.getElementById('cerrarModalExistente').addEventListener('click', () => {
        document.getElementById('modalReservaExistente').style.display = 'none'
      })

      document.getElementById('verReservaExistente').addEventListener('click', () => {
        document.getElementById('modalReservaExistente').style.display = 'none'
        mostrarReservas()
      })

      // Cerrar modal de reserva existente al hacer clic fuera de él
      document.getElementById('modalReservaExistente').addEventListener('click', (e) => {
        if (e.target.id === 'modalReservaExistente') {
          document.getElementById('modalReservaExistente').style.display = 'none'
        }
      })

      // Funcionalidad del botón de cancelar reserva
      document.getElementById('cancelarReserva').addEventListener('click', async () => {
        if (confirm('¿Estás seguro de que deseas cancelar tu reserva? Esta acción no se puede deshacer.')) {
          try {
            const datos = JSON.parse(localStorage.getItem('reserva_actual')) || []
            console.log('Datos de reserva a cancelar:', datos)
            
            if (datos.length > 0) {
              const cantidadPersonas = parseInt(datos[0].personas || 1)
              console.log('Cantidad de personas:', cantidadPersonas)
              
              // Obtener disponibilidad actual
              const disponibilidadActual = await obtenerDisponibilidadActual()
              console.log('Disponibilidad actual antes de restaurar:', disponibilidadActual)
              
              if (!disponibilidadActual) {
                alert('Error al obtener disponibilidad actual. Intenta de nuevo.')
                return
              }

              // Calcular nueva disponibilidad (restaurar lo que se había restado)
              let totalDesayunos = 0, totalComidas = 0, totalCenas = 0
              
              datos.forEach(r => {
                console.log(`Reserva: ${r.tipo} - ${r.fecha} - ${cantidadPersonas} personas`)
                if (r.tipo === 'desayuno') totalDesayunos += cantidadPersonas
                else if (r.tipo === 'comida') totalComidas += cantidadPersonas
                else if (r.tipo === 'cena') totalCenas += cantidadPersonas
              })

              console.log('Totales a restaurar:', { totalDesayunos, totalComidas, totalCenas })

              // Actualizar disponibilidad en la base de datos
              const nuevaDisponibilidad = {
                desayunos: disponibilidadActual.desayunos + totalDesayunos,
                comidas: disponibilidadActual.comidas + totalComidas,
                cenas: disponibilidadActual.cenas + totalCenas
              }

              console.log('Nueva disponibilidad calculada:', nuevaDisponibilidad)

              // Actualizar disponibilidad
              const actualizacionExitosa = await actualizarDisponibilidad(
                nuevaDisponibilidad.desayunos,
                nuevaDisponibilidad.comidas,
                nuevaDisponibilidad.cenas
              )

              if (!actualizacionExitosa) {
                console.error('Fallo en actualización de disponibilidad')
                // Continuar con la cancelación aunque falle la actualización
              }

              // Verificar que se actualizó correctamente
              const disponibilidadVerificada = await obtenerDisponibilidadActual()
              console.log('Disponibilidad después de actualizar:', disponibilidadVerificada)

              // Eliminar reservas de la base de datos
              const eliminacionExitosa = await eliminarReservas(datos)
              if (!eliminacionExitosa) {
                console.error('Fallo en eliminación de reservas')
                // Continuar con la cancelación aunque falle la eliminación
              }

              console.log('Reserva cancelada exitosamente.')
            }

            // Limpiar datos locales
            localStorage.removeItem('reserva_actual')
            
            // Cerrar la modal
            document.getElementById('modalReservas').style.display = 'none'
            
            // Actualizar contadores
            await cargarContadores(true)
            
            // Mostrar mensaje de confirmación
            alert('Tu reserva ha sido cancelada exitosamente.')
            
          } catch (error) {
            console.error('Error durante la cancelación:', error)
            alert('Error durante la cancelación. Intenta de nuevo.')
          }
        }
      })

      cargarContadores()
      cargarInformacionUsuario()
      sincronizarUsuarioConSesion()
      cargarReservasUsuario()  // Cargar reservas del usuario
      verificarCancelacion()  // Verificar si venimos de una cancelación
    })

    // Función para mostrar reservas en la modal
    function mostrarReservas() {
      const datos = JSON.parse(localStorage.getItem('reserva_actual'))
      const contenidoDiv = document.getElementById('contenidoReservas')
      const botonCancelar = document.getElementById('cancelarReserva')

      if (!datos || datos.length === 0) {
        contenidoDiv.innerHTML = '<div class="no-reservas">No hay reservas registradas.</div>'
        // Ocultar el botón de cancelar cuando no hay reservas
        botonCancelar.style.display = 'none'
        document.getElementById('modalReservas').style.display = 'flex'
        return
      }

      // Mostrar el botón de cancelar cuando hay reservas
      botonCancelar.style.display = 'block'

      const { nombre, celular, personas } = datos[0]

      let encabezadoHTML = `
        <div class="datos-usuario">
          <div><span class="etiqueta">Nombre:</span> ${nombre}</div>
          <div><span class="etiqueta">Celular:</span> ${celular}</div>
          <div><span class="etiqueta">Cantidad:</span> ${personas} persona(s)</div>
        </div>
        <div class="titulo-reservas">Reservas</div>
      `

      // Agrupar por fecha (igual que en reserva.html)
      const reservasPorFecha = {}
      datos.forEach(r => {
        if (!reservasPorFecha[r.fecha]) reservasPorFecha[r.fecha] = []
        reservasPorFecha[r.fecha].push(r.tipo)
      })

      let reservasHTML = ''

      Object.entries(reservasPorFecha).forEach(([fecha, tipos]) => {
        // Corregir el problema de zona horaria: crear la fecha correctamente
        const [anio, mes, dia] = fecha.split('-').map(Number)
        const fechaObj = new Date(anio, mes - 1, dia) // mes - 1 porque los meses van de 0-11
        const fechaFormateada = formatearFecha(fechaObj)
        const comidasTexto = tipos.map(tipo => obtenerIcono(tipo)).join(', ')
        reservasHTML += `<div class="reserva-dia"><strong>${fechaFormateada}</strong>: ${comidasTexto}</div>`
      })

      contenidoDiv.innerHTML = encabezadoHTML + reservasHTML
      document.getElementById('modalReservas').style.display = 'flex'
    }

    // Función para obtener icono de tipo de comida
    function obtenerIcono(tipo) {
      switch (tipo) {
        case 'desayuno': return '🥐 Desayuno'
        case 'comida': return '🍽️ Comida'
        case 'cena': return '🌙 Cena'
        default: return tipo
      }
    }

    // Función para verificar si el usuario ya tiene reservas activas
    async function verificarReservasExistentes() {
      try {
        const usuarioActual = JSON.parse(localStorage.getItem('usuario_actual'))
        if (!usuarioActual) return false

        const { data, error } = await supabase
          .from('reservas')
          .select('*')
          .eq('user_id', usuarioActual.id)
          .limit(1)

        if (error) {
          console.error('Error verificando reservas existentes:', error)
          return false
        }

        return data && data.length > 0
      } catch (error) {
        console.error('Error en verificarReservasExistentes:', error)
        return false
      }
    }

    // Función para mostrar modal de reserva existente
    function mostrarModalReservaExistente() {
      const modal = document.getElementById('modalReservaExistente')
      modal.style.display = 'flex'
    }
  </script>
</body>
</html>
